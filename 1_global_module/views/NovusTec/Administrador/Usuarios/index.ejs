<%- contentFor('head')%>
<% include ./../css %>

<%- contentFor('body')%>

<body id="page-top" class="sidebar-toggled">

  <!-- Page Wrapper -->
  <div id="wrapper">

    <% include ./../sidebar %>

    <!-- Content Wrapper -->
    <div id="content-wrapper" class="d-flex flex-column">

      <!-- Main Content -->
      <div id="content">

        <% include ./../top-bar %>

        <!-- Begin Page Content -->
        <div class="container-fluid">

          <!-- Page Heading -->
          <div class="d-sm-flex align-items-center justify-content-between mb-4">
            <h1 class="h3 mb-0 text-gray-800">Users Administration</h1>
            <!--<a href="#" class="d-none d-sm-inline-block btn btn-sm btn-primary shadow-sm"><i class="fas fa-download fa-sm text-white-50"></i> Generate Report</a>-->
          </div>

          <div class="row">
            <div class="col-md-12">
              <% if(error){ %>
              <div class="alert alert-danger alert-dismissable">
                <a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>
                <strong>¡Error!</strong> <%= error %>
              </div>
              <% } %>
            </div>
          </div>

          <div class="row">
            <!-- Area Chart -->
            <div class="col-xl-12 col-lg-12 col-sm-12 col-xs-12">
              <div class="card shadow mb-4">
                <a href="#collapseCardExample" class="d-block card-header py-3" data-toggle="collapse" role="button" aria-expanded="true" aria-controls="collapseCardExample">
                  <h6 class="m-0 font-weight-bold text-primary"><i class="fas fa-plus-circle"></i> Add User</h6>
                </a>
                <!-- Card Content - Collapse -->
                <div class="collapse" id="collapseCardExample">
                  <div class="card-body">
                    <form class="form-horizontal" id="form_usuario_administrador">
                      <fieldset>
                        <!-- Text input-->
                        <div class="form-group row">
                          <label for="nombre_usuario_administracion_agregar" class="col-form-label col-sm-2" title="Obligatory field"><label class="font-weight-bold text-danger" title="Obligatory field">*</label> Names</label>
                          <div class="col-md-8">
                            <input id="nombre_usuario_administracion_agregar" name="nombre" type="text" class="form-control input-md" required="">
                          </div>
                        </div>
                        <div class="form-group row">
                          <label for="apellido_paterno_usuario_administracion_agregar" class="col-form-label col-sm-2" title="Obligatory field"><label class="font-weight-bold text-danger" title="Obligatory field">*</label> Last name</label>
                          <div class="col-md-8">
                            <input id="apellido_paterno_usuario_administracion_agregar" name="apellidoPaterno" type="text" class="form-control input-md" required="">
                          </div>
                        </div>
                        <div class="form-group row">
                          <label for="apellido_materno_usuario_administracion_agregar" class="col-form-label col-sm-2">Second last name</label>
                          <div class="col-md-8">
                            <input id="apellido_materno_usuario_administracion_agregar" name="apellidoMaterno" type="text" class="form-control input-md" >
                          </div>
                        </div>
                        <div class="form-group row">
                          <label for="correo_usuario_administracion_agregar" class="col-form-label col-sm-2" title="Obligatory field"><label class="font-weight-bold text-danger" title="Obligatory field">*</label> Email</label>
                          <div class="col-md-8">
                            <input id="correo_usuario_administracion_agregar" name="correoElectronico" type="text" class="form-control input-md" required="">
                          </div>
                        </div>
                        <small id="texto_error" class="text-danger"></small>
                        <div class="form-group row">
                          <label for="contrasena_usuario_administracion_agregar" class="col-form-label col-sm-2" title="Obligatory field"><label class="font-weight-bold text-danger" title="Obligatory field">*</label> Password</label>
                          <div class="col-md-8">
                            <input id="contrasena_usuario_administracion_agregar" name="contrasena" type="password" class="form-control input-md" required="">
                          </div>
                        </div>
                        <div class="form-group row">
                          <label for="contrasena_repetir_usuario_administracion_agregar" class="col-form-label col-sm-2" title="Obligatory field"><label class="font-weight-bold text-danger" title="Obligatory field">*</label> Confirm password</label>
                          <div class="col-md-8">
                            <input id="contrasena_repetir_usuario_administracion_agregar" name="contrasena_repetir" type="password" class="form-control input-md" required="">
                          </div>
                        </div>
                        <div class="form-group row">
                          <label for="permiso_usuario_administracion_agregar" class="col-form-label col-sm-2">Type of User</label>
                          <div class="col-md-10">
                            <select id="permiso_usuario_administracion_agregar" name="permiso" class="form-control selectpicker" data-live-search="true" disabled>
                              <option value="SUPERADMIN">Administrator</option>
                              <!--<option value="MODERADOR">Adviser</option>-->
                            </select>
                            <input type="hidden" name="permiso" value="SUPERADMIN">
                          </div>
                        </div>

                        <!-- Button -->
                        <div class="form-group">
                          <div class="col-md-12">
                            <button id="singlebutton" name="singlebutton" class="btn btn-primary btn-block">Save</button>
                          </div>
                        </div>

                      </fieldset>
                    </form>
                  </div>
                </div>
              </div>
              <input id="currentId" value="<%=currentUser.id%>" hidden>
              <div class="card shadow mb-4">
                <div class="card-header py-3">
                  <h6 class="m-0 font-weight-bold text-primary">User data</h6>
                </div>
                <div class="card-body">
                  <div class="table-responsive">
                    <table class="table table-bordered" id="dataTable" width="100%" cellspacing="0">

                    </table>
                  </div>
                </div>
              </div>
            </div>

          </div>

        </div>
        <!-- /.container-fluid -->

      </div>
      <!-- End of Main Content -->

    </div>
    <!-- End of Content Wrapper -->

  </div>
  <!-- End of Page Wrapper -->

  <!-- Scroll to Top Button-->
  <a class="scroll-to-top rounded" href="#page-top">
    <i class="fas fa-angle-up"></i>
  </a>

  <div class="modal fade" id="editModal" tabindex="-1" role="dialog" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editModalLabel">Edit Users Administration</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <form class="form-horizontal" id="form_usuario_administrador_edit">
          <div class="modal-body">
            <input type="hidden" id="objectId_usuario_administrador_editar" name="objectId">
            <!-- Text input-->
            <div class="form-group row">
              <label for="nombre_usuario_administracion_editar" class="col-form-label col-sm-3" title="Obligatory field"><label class="font-weight-bold text-danger" title="Obligatory field">*</label> Names</label>
              <div class="col-md-9">
                <input id="nombre_usuario_administracion_editar" name="nombre" type="text" class="form-control input-md" required="">
              </div>
            </div>
            <div class="form-group row">
              <label for="apellido_paterno_usuario_administracion_editar" class="col-form-label col-sm-3" title="Obligatory field"><label class="font-weight-bold text-danger" title="Obligatory field">*</label> Last name</label>
              <div class="col-md-9">
                <input id="apellido_paterno_usuario_administracion_editar" name="apellidoPaterno" type="text" class="form-control input-md" required="">
              </div>
            </div>
            <div class="form-group row">
              <label for="apellido_materno_usuario_administracion_editar" class="col-form-label col-sm-3">Second Last name</label>
              <div class="col-md-9">
                <input id="apellido_materno_usuario_administracion_editar" name="apellidoMaterno" type="text" class="form-control input-md" >
              </div>
            </div>
            <div class="form-group row">
              <label for="correo_usuario_administracion_editar" class="col-form-label col-sm-3" title="Obligatory field"><label class="font-weight-bold text-danger" title="Obligatory field">*</label> Email</label>
              <div class="col-md-9">
                <input id="correo_usuario_administracion_editar" name="correoElectronico" type="text" class="form-control input-md" disabled="" required="">
              </div>
            </div>
            <small id="texto_error_editar" class="text-danger"></small>
            <div class="form-group row">
              <label for="contrasena_usuario_administracion_editar" class="col-form-label col-sm-3" >Password</label>
              <div class="col-md-9">
                <input id="contrasena_usuario_administracion_editar" name="contrasena" type="password" class="form-control input-md">
              </div>
            </div>
            <div class="form-group row">
              <label for="contrasena_repetir_usuario_administracion_editar" class="col-form-label col-sm-3" >Confirm password</label>
              <div class="col-md-9">
                <input id="contrasena_repetir_usuario_administracion_editar" name="contrasena_repetir" type="password" class="form-control input-md">
              </div>
            </div>
            <div class="form-group row">
              <label for="permiso_usuario_administracion_editar" class="col-form-label col-sm-3">Type user</label>
              <div class="col-md-9">
                <select id="permiso_usuario_administracion_editar" name="permiso" class="form-control selectpicker" data-live-search="true" >
                  <option value="SUPERADMIN">Administrator</option>
                  <option value="MODERADOR">Adviser</option>
                </select>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-primary">Update</button>
          </div>
        </form>
      </div>
    </div>
  </div>

</body>

<%- contentFor('scripts')%>
<% include ./../scripts %>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@9"></script>
<script>
  var log = console.log
  var table

  reloadTable()

  function reloadTable() {
    log("Recargando tabla")
    $.ajax({
      type: "GET",
      url: "/administrador/usuarios_administracion/datos",
      success: function(response) {
        //log(response.data)
        var currentUser = $("#currentId").val()
        if ($.fn.DataTable.isDataTable("#dataTable")) {
          //$("#table_report").DataTable().clear().draw();
          $("#dataTable").dataTable().fnDestroy();
          //$("#table_report").dataTable();
          $('#dataTable').empty();
        }

        var thead = ""
        var tfooter = ""

        thead += '<thead>'
        thead += '<tr>'
        thead += '<th>Name</th>'
        thead += '<th>Email</th>'
        thead += '<th>Type</th>'
        thead += '<th>Status</th>'
        thead += '<th>Created At</th>'
        thead += '<th>Action</th>'
        thead += '</tr>'
        thead += '</thead>'
        tfooter += '<tfoot>'
        tfooter += '<tr>'
        tfooter += '<th>Name</th>'
        tfooter += '<th>Email</th>'
        tfooter += '<th>Type</th>'
        tfooter += '<th>Status</th>'
        tfooter += '<th>Created At</th>'
        tfooter += '<th>Action</th>'
        tfooter += '</tr>'
        tfooter += '</tfoot>'

        $('#dataTable').append(thead);
        $('#dataTable').append(tfooter);

        $.fn.dataTable.moment('DD-MM-YYYY');
        $('#dataTable').dataTable({
          processing: true,
          lengthMenu: [100, 10, 25, 50, 75],
          order: [
            [0, "asc"]
          ],
          deferRender: true,
          data: response.data,
          columns: [{
              data: null,
              render: function(data, type, row) {
                var nombre          = data["nombre"] ?   data["nombre"] : '' 
                var apellidoPaterno = data["apellidoPaterno"] ?  data["apellidoPaterno"] : '' 
                var apellidoMaterno = data["apellidoMaterno"] ?    data["apellidoMaterno"] :'' 
                var nombreCompleto = nombre + " " + apellidoPaterno + " " + apellidoMaterno
                return nombreCompleto
              }
            },
            {
              data: "correoElectronico"
            },
            {
              data: null,
              render: function(data, type, row) {
                //return ""
                //return data["permisoPtr"] ? data["permisoPtr"]["nombre"] : ""
                if (!data["permisoPtr"]["nombre"]) {
                  return ""
                }
                if (data["permisoPtr"]["nombre"] == "Super Administrador") {
                  return "Administrator"
                }
                if (data["permisoPtr"]["nombre"] == "Moderador") {
                  return "Adviser"
                }
              }
            },
            {
              data: null,
              render: function(data, type, row) {
                if (data["active"]) return '<span class="badge badge-success">Activo</span>'
                else return '<span class="badge badge-secondary">Inactivo</span>'
              }
            },
            {
              data: null,
              render: function(data, type, row) {
                return moment(data["createdAt"]).format('DD-MM-YYYY')
              }
            },
            {
              data: null,
              render: function(data, type, row) {
                var nombre          = data["nombre"] ?   data["nombre"] : '' 
                var apellidoPaterno = data["apellidoPaterno"] ?  data["apellidoPaterno"] : '' 
                var apellidoMaterno = data["apellidoMaterno"] ?    data["apellidoMaterno"] :'' 
                
                var data_to_add = ""

                data_to_add = "<div class='row ml-2 mr-4' style='width:180px'>"

                data_to_add += "<div class='col-md-3'>"
                data_to_add += '<span data-toggle="modal" data-target="#editModal" data-id="' + data["objectId"] + '" data-nombre="' + nombre + '"  data-apellido-paterno="' + apellidoPaterno + '" data-apellido-materno="' + apellidoMaterno + '" data-correo-electronico="' + data["correoElectronico"] + '" data-permiso="' + data["permisoPtr"]["clave"] + '"><button type"button" class="btn btn-primary btn-circle"  data-toggle="tooltip" data-placement="bottom" title="Edit"><i class="fas fa-edit"></i></button></span>'
                data_to_add += "</div>"

                data_to_add += "<div class='col-md-3'>"
                data_to_add += '<a href="/administrador/usuarios_administracion/historial/'+data["objectId"]+'" target="_blank" class="btn btn-info btn-circle" data-toggle="tooltip" data-placement="bottom" title="History"><i class="far fa-clock" ></i></a>'
                data_to_add += "</div>"

                if (currentUser != data["objectId"]) {

                  if (data["active"]) {
                    data_to_add += "<div class='col-md-3'>"
                    data_to_add += '<button id="active" type"button" onclick="ActivacionUsuarioAdministrador(\'' + data["objectId"] + '\',false)" type="button" class="btn btn-warning btn-circle" data-toggle="tooltip" data-placement="bottom" title="Deactivate"><i class="fas fa-archive" ></i></button>'
                    data_to_add += "</div>"
                  } else {
                    data_to_add += "<div class='col-md-3'>"
                    data_to_add += '<button id="active" type"button" onclick="ActivacionUsuarioAdministrador(\'' + data["objectId"] + '\',true)" type="button" class="btn btn-success btn-circle" data-toggle="tooltip" data-placement="bottom" title="Activate"><i class="fas fa-archive"></i></button>'
                    data_to_add += "</div>"
                  }
                  data_to_add += "<div class='col-md-3'>"
                  data_to_add += '<button id="elimniar" type"button" onclick="EliminarUsuarioAdministrador(\'' + data["objectId"] + '\')" type="button" class="btn btn-danger btn-circle" data-toggle="tooltip" data-placement="bottom" title="Delete"><i class="fas fa-eraser"></i></button>'
                  data_to_add += "</div>"

                }

                data_to_add += "</div>"

                return data_to_add
              }
            }
          ],
          /*dom: 'Bfrtip',
          buttons: [
              { extend: 'csv', className: 'btn btn-primary glyphicon glyphicon-save-file', exportOptions: {columns: [0] }},
              { extend: 'excel', className: 'btn btn-primary glyphicon glyphicon-list-alt', exportOptions: {columns: [0] }},
              { extend: 'pdf', className: 'btn btn-primary glyphicon glyphicon-file', exportOptions: {columns: [0] }}
          ],*/
        });
      },
      error: function(XMLHttpRequest, textStatus, errorThrown) {

      }
    });
  }
</script>

<script>
  // Helpers script
  function validateEmail(email) {
    const re = /^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
    return re.test(String(email).toLowerCase());
  }
</script>

<script>
  // Agregar usuario
  $("#form_usuario_administrador").submit(function(event) {
    event.preventDefault();

    var expreRegular = /^(?=.*\d)(?=.*[a-z])(?=.*[A-Z]).{8,}$/;
    
    if (expreRegular.test($("#contrasena_usuario_administracion_agregar").val()) == false && expreRegular.test($("#contrasena_repetir_usuario_administracion_agregar").val()) == false) {
      return mensajeErrorContasena("The password does not have the indicated format, the password must contain at least one number, one uppercase letter, one lowercase letter, and at least 8 characters.")
    }
    if ($("#contrasena_usuario_administracion_agregar").val() === $("#contrasena_repetir_usuario_administracion_agregar").val()) {
      if (validateEmail($("#correo_usuario_administracion_agregar").val())) {
        $.ajax({
          type: "POST",
          data: $(this).serialize(),
          url: "/administrador/usuarios_administracion/datos_agregar",
          success: function(response) {
            //log(response.data)
            reloadTable()
            $("#form_usuario_administrador").trigger("reset");
            $("#collapseCardExample").collapse('hide');
            Swal.fire(
              'Added!',
              'User has been added successfully',
              'success'
            )
          },
          error: function(XMLHttpRequest, textStatus, errorThrown) {
             $("#collapseCardExample").collapse('hide');
            Swal.fire(
              '¡Error!',
              XMLHttpRequest.responseJSON.error + '. Try again',
              'error'
            )
          }
        })
      } else {
        Swal.fire(
          'Email!',
          'Please enter a valid email, try again',
          'warning'
        )
      }
    } else {
      Swal.fire(
        'Password!',
        'Passwords are not the same, please try again',
        'warning'
      )
    }
  });

  $('#editModal').on('show.bs.modal', function(e) {
    //log(e.relatedTarget)
    var objectId = $(e.relatedTarget).data('id');
    var nombre = $(e.relatedTarget).data('nombre');
    var apellidoPaterno = $(e.relatedTarget).data('apellido-paterno');
    var apellidoMaterno = $(e.relatedTarget).data('apellido-materno');
    var correoElectronico = $(e.relatedTarget).data('correo-electronico');
    var permiso = $(e.relatedTarget).data('permiso');
    $("#objectId_usuario_administrador_editar").val(objectId);
    $("#nombre_usuario_administracion_editar").val(nombre);
    $("#apellido_paterno_usuario_administracion_editar").val(apellidoPaterno);
    $("#apellido_materno_usuario_administracion_editar").val(apellidoMaterno);
    $("#correo_usuario_administracion_editar").val(correoElectronico);
    $("#permiso_usuario_administracion_editar").selectpicker('val', permiso)
    $("#contrasena_usuario_administracion_editar").val("")
    $("#contrasena_repetir_usuario_administracion_editar").val("")
  });

  $("#form_usuario_administrador_edit").submit(function(event) {
    event.preventDefault();

    var contrasena1 = $("#contrasena_usuario_administracion_editar").val()
    var contrasena2 = $("#contrasena_repetir_usuario_administracion_editar").val()

    var expreRegular = /^(?=.*\d)(?=.*[a-z])(?=.*[A-Z]).{8,}$/;

    if(contrasena1.length != 0  || contrasena2.length != 0){
      if (expreRegular.test(contrasena1) == false && expreRegular.test(contrasena2) == false) {
        return mensajeErrorContasenaEditar("The password does not have the indicated format, the password must contain at least one number, one uppercase letter, one lowercase letter, and at least 8 characters.")
      }
    }

    if ($("#contrasena_usuario_administracion_editar").val() === $("#contrasena_repetir_usuario_administracion_editar").val()) {
      if (validateEmail($("#correo_usuario_administracion_editar").val())) {
        $.ajax({
          type: "POST",
          data: $(this).serialize(),
          url: "/administrador/usuarios_administracion/datos_editar",
          success: function(response) {
            //log(response.data)
            reloadTable()
            Swal.fire(
              'Edited!',
              'User has been edited successfully',
              'success'
            )
            $('#editModal').modal('toggle');
          },
          error: function(XMLHttpRequest, textStatus, errorThrown) {
            $('#editModal').modal('toggle');
            Swal.fire(
              'Error!',
              'An error occurred while performing the action, please try again',
              'error'
            )
          }
        })
      } else {
        $('#editModal').modal('toggle');
        Swal.fire(
          'Email!',
          'Please enter a valid email, try again',
          'warning'
        )
      }
    } else {
      Swal.fire(
        'Passwords!',
        'Passwords are not the same, please try again',
        'warning'
      )
    }
  });

  function ActivacionUsuarioAdministrador(objectId, seActiva) {
    if (seActiva) {
      Swal.fire({
        title: 'Activate',
        text: "Do you want to activate this user?",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        cancelButtonText: 'Cancel',
        confirmButtonText: 'Activate'
      }).then((result) => {
        if (result.value) {
          $.ajax({
            type: "POST",
            data: {
              "objectId": objectId,
              "seActiva": seActiva
            },
            url: "/administrador/usuarios_administracion/datos_archivar",
            success: function(response) {
              //log(response.data)
              reloadTable()
              Swal.fire(
                'Activated!',
                'The user has been activated successfully',
                'success'
              )
            },
            error: function(XMLHttpRequest, textStatus, errorThrown) {
              Swal.fire(
                '¡Error!',
                'An error occurred while performing the action, please try again',
                'success'
              )
            }
          })

        }
      })
    } else {
      Swal.fire({
        title: 'Deactivate',
        text: "Do you want to deactivate this user?",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        cancelButtonText: 'Cancel',
        confirmButtonText: 'Deactivate'
      }).then((result) => {
        if (result.value) {
          $.ajax({
            type: "POST",
            data: {
              "objectId": objectId,
              "seActiva": seActiva
            },
            url: "/administrador/usuarios_administracion/datos_archivar",
            success: function(response) {
              //log(response.data)
              reloadTable()
              Swal.fire(
                'Deactivated!',
                'the user has been succesfully deactivated',
                'success'
              )
            },
            error: function(XMLHttpRequest, textStatus, errorThrown) {
              Swal.fire(
                '¡Error!',
                'An error occurred while performing the action, please try again',
                'success'
              )
            }
          })
        }
      })
    }
  }

  function EliminarUsuarioAdministrador(objectId) {
    Swal.fire({
      title: 'Delete',
      text: "Do you want to delete this user?",
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#3085d6',
      cancelButtonColor: '#d33',
      cancelButtonText: 'Cancel',
      confirmButtonText: 'Delete'
    }).then((result) => {
      if (result.value) {
        $.ajax({
          type: "POST",
          data: {
            "objectId": objectId
          },
          url: "/administrador/usuarios_administracion/datos_eliminar",
          success: function(response) {
            //log(response.data)
            reloadTable()
            Swal.fire(
              'Deleted!',
              'The user has been succesfully deleted',
              'success'
            )


          },
          error: function(XMLHttpRequest, textStatus, errorThrown) {
            Swal.fire(
              'Error!',
              'An error ocurred while performing the action, please try again',
              'success'
            )
          }
        })
      }
    })
  }
</script>

<script type="text/javascript">
  function mensajeErrorContasena(texto) {

    setTimeout(function() {
      $("#texto_error").show()
      $("#texto_error").text(texto)
    }, 1000);

    // setTimeout(function() {
    //   $("#texto_error").hide()
    // }, 9000);
  }

  function mensajeErrorContasenaEditar(texto) {

    setTimeout(function() {
      $("#texto_error_editar").show()
      $("#texto_error_editar").text(texto)
    }, 1000);

    // setTimeout(function() {
    //   $("#texto_error_editar").hide()
    // }, 9000);
  }
</script>